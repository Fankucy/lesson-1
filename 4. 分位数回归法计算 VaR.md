# 分位数回归法计算 VaR


## 一、实验介绍

### 1.1 实验内容

从 2000 年的科技股泡沫，到 2008 年的次贷危机，我们看到了金融风险对全球经济强大的破坏力。
金融风险是什么？如何度量它？我们可以为它做哪些准备？金融风险管理系列课程将对这些问题做出解答。
通过系列课程的学习，你将：
 - 读懂上市公司或商业银行信息披露中的风险指标
 - 计算你所购买的投资组合的在险价值，对投资风险的大小进行评估
 - 对计量模型和 R 语言的运用有更深的理解

本节课程主要介绍如何使用分位数回归法计算 VaR。

### 1.2 实验知识点

 - 分位数回归法

### 1.3 实验环境

 - R 3.4.1
 - Xfce 终端

### 1.4 适合人群

本节课程难度适中，适合于有概率统计基础的朋友。

## 二、分位数回归法
上一节课，我们学习了历史模拟法和蒙特卡罗模拟法。在计算 VaR 时，两种模拟方法的最后一步都是对模拟得到的样本求解分位数，这源于 VaR 的统计学意义。不同的是，蒙特卡罗模拟法假设随机变量服从一个特别的分布，而历史模拟法不需要这样的假设，它只要求随机变量的分布从过去延续到未来。
今天我们要介绍的分位数回归法和历史模拟法一样，不需要假设随机变量的分布类型，只要求分布的延续性。
问题是，我们已经有了历史模拟法，为什么还要提出分位数回归法？
这是因为，在研究一个实际问题的时候，我们通常能发现一些与关键问题联系非常紧密的变量，并且想用这些变量来解释目标变量。例如，在研究 A 股市场一支股票的收益率时，我们基于经济理论猜想它与国债利率联系紧密，于是我们把国债利率作为解释变量进行回归。

谈到回归，我们脑海中首先浮现的是经典线性回归，这是最基础、最简单，也是最有用的一种回归。它有许许多多的假设：对抽样的假设，对随机扰动项的假设，对解释变量的假设…… 正是这些近乎严苛的假设给了最小二乘估计量非常优秀的性质：**BLUE（Best Linear Unbiased Estimate）最佳线性无偏估计**。
要理解分位数回归，我们只需要知道一点，即**线性回归是一种特殊的分位数回归**。
对比线性回归和分位数回归，我们发现，它们的解释变量都是由我们选定的，区别在于**被解释变量**上。线性回归的被解释变量是期望值，也就是均值。而分位数回归的被解释变量是分位数。这并不值得惊奇，因为均值是特殊的分位数（二分之一分位数）。
理解分位数回归是什么之后，我们不浪费时间在冗杂的公示表达上，直接进入实例掌握分位数回归在 R 中的操作。


## 三、实验步骤
我们仍然使用前两节课的例子来展示如何通过分位数回归法计算 VaR。当然，我们需要人为设置解释变量。为了突出重点，我们只计算单位头寸单期的 VaR。要计算多期，思路仍然是把多期看作整体构建新的序列，此处不再赘述。
**实例：**
**假设某投资者持有价值 100 万美元的 GOOGLE 公司股票，请利用过去 5 年（2012-09-27 到 2017-09-27）的日度交易数据预测未来一天内该头寸在 95% 的置信水平下可能遭受的最大损失。**
**分位数回归的解释变量采用 Gaussian GARCH（1，1）模型下滞后一阶的波动率、滞后一阶损失变量的绝对值，判断它们的系数在 `$$\alpha$$` = 0.05 的显著性水平下是否显著。**


### 3.1 数据处理与程序包准备

实验所需数据已上传。计算前，先从云端下载数据。
```
# 下载实验所需数据
$ wget http://labfile.oss.aliyuncs.com/courses/954/GOOGL-rq.csv
```

![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid530978labid3721timestamp1507688724583.png/wm)


```
# 启动 R
$ sudo R
```
<img src="https://dn-anything-about-doc.qbox.me/document-uid530978labid3719timestamp1506587286704.png/wm"  />


安装和加载 `quantreg`包。
```
> install.packages('quantreg')
> library(quantreg)
```
加载成功的界面如下图所示：
![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid530978labid3721timestamp1507629144519.png/wm)

接下来我们读取 csv 文件，将其中的数据保存在 R 的变量里。
```
# 将数据保存在 R 的一个变量 dd 中
> dd <- read.csv('GOOGL-rq.csv', header = TRUE)
# 查看 dd 的前 6 行
> head(dd)
```
![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid530978labid3721timestamp1507689171948.png/wm)
我们用 `head` 函数查看了 `dd` 的前 6 行，发现 `dd` 由 3 列（3 个变量）构成，它们分别是损失变量 loss，滞后一阶的波动率 sigl，滞后一阶的损失变量绝对值 absl。这些变量的数据是如何得到的呢？
我们在前两节课中已经使用 GOOGL 股票调整后的收盘价计算得到损失变量 loss，它的绝对值 absl 很容易得到。要求 Gaussian GARCH（1，1）模型下滞后一阶的波动率，需要先建立 Gaussian GARCH（1，1）模型，我们在第二、三节课中已经介绍过，不要忘记安装和加载 `rugarch` 软件包哦。拟合完 GARCH 模型后，我们用 `sigma` 函数提取 `fit` 结果中的标准差（波动率），再进行滞后操作。

至此，准备工作已经做完。下面我们使用分位数回归法来计算 VaR。

### 3.2 分位数回归
我们使用 `quantreg` 包中的 `rq` 函数进行分位数回归，形式如下所示，`~` 左边为被解释变量，右边为解释变量，`tau` 为分位数，`data` 为数据，数据中需要包含解释变量和被解释变量。
```
# 进行分位数回归
> mm <- rq(loss ~ sigl + absl, tau = 0.95, data = dd)
# 查看回归结果
> summary(mm)
```
![此处输入图片的描述](https://dn-anything-about-doc.qbox.me/document-uid530978labid3721timestamp1507690565256.png/wm)
从回归结果中我们可以看到，常数项、sigl 和 absl 的系数在 `$$\alpha$$` = 0.05 的显著性水平下都显著，因为它们的 p 值都小于 0.05。
`$$1.00424+0.49267\times1.204513+0.39962\times0.3365871=1.732174$$`，所以单位头寸在未来一天内的 VaR 为 1.7322%。算式中的 1.00424，0.49267，0.39962 分别为分位数回归结果中的常数项、sigl 系数和 absl 系数估计值。1.204513 和 0.3365871 分别为当期的波动率和损失变量绝对值，它们相对于下一期（我们要估计的那一期）来说是滞后一期的解释变量，可以通过 `tail` 函数从 3.1 节所描述的数据中得到。
## 四、总结

本节课程从历史模拟法和线性回归出发引出了分位数回归，然后通过实例介绍了如何使用分位数回归法计算 VaR。
